<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>åˆ›å»ºæ¨ç†ä»»åŠ¡ Â· æ•°æ®é€‰æ‹©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --primary: #1677ff;
      --border: #e5e7eb;
      --text: #1f2937;
      --muted: #6b7280;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      font-weight: 600;
    }
    .steps {
      display: flex;
      gap: 24px;
      font-size: 14px;
      margin-top: 8px;
    }
    .step.active { color: var(--primary); }
    .container { padding: 16px 24px; }

    .workspace {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      height: 520px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .panel-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .panel-body {
      padding: 8px 12px;
      overflow: auto;
      font-size: 13px;
      flex: 1;
      min-width: 0;
    }

    /* Treeï¼ˆå±‚çº§ä¸Šä¸‹å±•ç¤ºï¼Œé¿å…æ¨ªå‘æŒ¤å‹ï¼‰ */
    .tree ul { list-style: none; padding-left: 16px; margin: 6px 0; }
    .tree li { margin: 6px 0; }
    .tree .branch {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }
    .tree .caret {
      width: 14px;
      display: inline-flex;
      justify-content: center;
      color: var(--muted);
    }
    .tree .branch-title {
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tree .children { margin-top: 6px; }
    .tree .children[data-collapsed="true"] { display: none; }

    .tree .file-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-left: 18px;
    }
    .tree .file-main {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
    }
    .tree .file-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tree .file-name.active {
      font-weight: 600;
      color: var(--primary);
    }
    .tree input[type="checkbox"] { margin: 0; }

    .preview-icon {
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
      padding: 2px 8px;
      border-radius: 6px;
      flex-shrink: 0;
      border: 1px solid transparent;
    }
    .preview-icon:hover { border-color: var(--border); }
    .preview-icon.active { color: #fff; background: var(--primary); border-color: var(--primary); }

    /* Preview table */
    table {
      border-collapse: collapse;
      width: max-content;   /* å…³é”®ï¼šåˆ—å¤šæ—¶è§¦å‘æ¨ªå‘æ»šåŠ¨ */
      min-width: 100%;
      font-size: 12px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 4px 6px;
      white-space: nowrap;
    }
    th { background: #f3f4f6; }

    /* Bottom config */
    .config {
      margin-top: 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
    }
    .config h3 {
      margin: 0 0 8px;
      font-size: 14px;
    }
    .hint { font-size: 12px; color: var(--muted); margin: 6px 0; }
    .hint.danger { color: var(--danger); }

    .file-role-table {
      width: 100%;
      margin-bottom: 12px;
      border-collapse: collapse;
    }
    .file-role-table th, .file-role-table td {
      font-size: 12px;
      border: 1px solid var(--border);
      padding: 6px;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      margin: 2px;
      cursor: pointer;
      user-select: none;
    }
    .tag.selected { background: var(--primary); color: #fff; border-color: var(--primary); }

    footer {
      display: flex;
      justify-content: space-between;
      padding: 12px 24px;
      background: var(--panel);
      border-top: 1px solid var(--border);
    }
    button {
      padding: 6px 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    button.primary {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .header-actions { display:flex; align-items:center; gap:8px; }
    .ghost {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 6px;
      background: #fff;
      border: 1px solid var(--border);
    }
  </style>
</head>
<body>
<header>
  åˆ›å»ºæ¨ç†ä»»åŠ¡
  <div class="steps">
    <div class="step">â‘  åŸºæœ¬ä¿¡æ¯</div>
    <div class="step active">â‘¡ æ•°æ®ä¸ç›®æ ‡</div>
    <div class="step">â‘¢ å‚æ•°é…ç½®</div>
  </div>
</header>

<div class="container">
  <div class="workspace">
    <!-- Left: Tree -->
    <div class="panel">
      <div class="panel-header">æ•°æ®èµ„äº§</div>
      <div class="panel-body tree" id="treeRoot">
        <ul>
          <li>
            <div class="branch" data-branch="dataset_sensors">
              <span class="caret">â–¾</span>
              <span class="branch-title">ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨</span>
            </div>
            <div class="children" data-collapsed="false">
              <ul>
                <li>
                  <div class="branch" data-branch="ver_v11">
                    <span class="caret">â–¾</span>
                    <span class="branch-title">ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨æ•°æ®é›† v1.1</span>
                  </div>
                  <div class="children" data-collapsed="false">
                    <ul>
                      <li class="file-row" data-file="ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨1.csv">
                        <div class="file-main">
                          <input type="checkbox" checked />
                          <span class="file-name active">ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨1.csv</span>
                        </div>
                        <span class="preview-icon active" title="é¢„è§ˆ" data-file="ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨1.csv">ğŸ‘</span>
                      </li>
                      <li class="file-row" data-file="ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨2.csv">
                        <div class="file-main">
                          <input type="checkbox" checked />
                          <span class="file-name">ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨2.csv</span>
                        </div>
                        <span class="preview-icon" title="é¢„è§ˆ" data-file="ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨2.csv">ğŸ‘</span>
                      </li>
                      <li class="file-row" data-file="ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨3.csv">
                        <div class="file-main">
                          <input type="checkbox" checked />
                          <span class="file-name">ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨3.csv</span>
                        </div>
                        <span class="preview-icon" title="é¢„è§ˆ" data-file="ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨3.csv">ğŸ‘</span>
                      </li>
                    </ul>
                  </div>
                </li>
                <li>
                  <div class="branch" data-branch="ver_v12">
                    <span class="caret">â–¸</span>
                    <span class="branch-title">ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨æ•°æ®é›† v1.2</span>
                  </div>
                  <div class="children" data-collapsed="true">
                    <ul>
                      <li class="file-row" data-file="ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨_2025Q1.csv">
                        <div class="file-main">
                          <input type="checkbox" />
                          <span class="file-name">ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨_2025Q1.csv</span>
                        </div>
                        <span class="preview-icon" title="é¢„è§ˆ" data-file="ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨_2025Q1.csv">ğŸ‘</span>
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>
            </div>
          </li>

          <li>
            <div class="branch" data-branch="dataset_erp">
              <span class="caret">â–¸</span>
              <span class="branch-title">ERP ç³»ç»Ÿæ•°æ®é›†</span>
            </div>
            <div class="children" data-collapsed="true">
              <ul>
                <li>
                  <div class="branch" data-branch="erp_v11">
                    <span class="caret">â–¸</span>
                    <span class="branch-title">ERP æ•°æ®é›† v1.1</span>
                  </div>
                  <div class="children" data-collapsed="true">
                    <ul>
                      <li class="file-row" data-file="erp_orders.csv">
                        <div class="file-main">
                          <input type="checkbox" />
                          <span class="file-name">erp_orders.csv</span>
                        </div>
                        <span class="preview-icon" title="é¢„è§ˆ" data-file="erp_orders.csv">ğŸ‘</span>
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>
            </div>
          </li>

          <li>
            <div class="branch" data-branch="dataset_maint">
              <span class="caret">â–¸</span>
              <span class="branch-title">è®¾å¤‡ç»´ä¿®æ—¥å¿—</span>
            </div>
            <div class="children" data-collapsed="true">
              <ul>
                <li class="file-row" data-file="maintenance_logs.csv">
                  <div class="file-main">
                    <input type="checkbox" />
                    <span class="file-name">maintenance_logs.csv</span>
                  </div>
                  <span class="preview-icon" title="é¢„è§ˆ" data-file="maintenance_logs.csv">ğŸ‘</span>
                </li>
              </ul>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Right: Preview -->
    <div class="panel" id="previewPanel">
      <div class="panel-header">
        <span id="previewTitle">æ•°æ®é¢„è§ˆï¼ˆå·²é€‰æ‹© 3 ä¸ªæ–‡ä»¶ï¼‰</span>
        <div class="header-actions">
          <button class="ghost" id="fullscreenBtn" type="button">å…¨å±</button>
        </div>
      </div>
      <div class="panel-body" id="previewBody">
        <table>
          <thead>
            <tr>
              <th>timestamp</th>
              <th>temperature</th>
              <th>humidity</th>
              <th>pressure</th>
              <th>vibration</th>
              <th>voltage</th>
              <th>current</th>
              <th>rpm</th>
              <th>torque</th>
              <th>power</th>
              <th>energy</th>
              <th>status_code</th>
            </tr>
          </thead>
          <tbody id="previewTbody">
            <!-- å¤šè¡Œ + å¤šåˆ— mockï¼ŒéªŒè¯ä¸Šä¸‹ / å·¦å³æ»šåŠ¨ -->
            <tr><td>2024-12-01</td><td>-1.2</td><td>52</td><td>101.5</td><td>0.09</td><td>220</td><td>5.1</td><td>1450</td><td>12.3</td><td>2.7</td><td>18.2</td><td>0</td></tr>
            <tr><td>2024-12-02</td><td>-0.8</td><td>53</td><td>101.4</td><td>0.11</td><td>221</td><td>5.0</td><td>1460</td><td>12.5</td><td>2.8</td><td>18.6</td><td>0</td></tr>
            <tr><td>2024-12-03</td><td>-0.3</td><td>54</td><td>101.3</td><td>0.10</td><td>219</td><td>5.2</td><td>1470</td><td>12.7</td><td>2.9</td><td>19.0</td><td>1</td></tr>
            <tr><td>2024-12-04</td><td>0.1</td><td>55</td><td>101.2</td><td>0.12</td><td>222</td><td>5.3</td><td>1480</td><td>12.9</td><td>3.0</td><td>19.5</td><td>0</td></tr>
            <tr><td>2024-12-05</td><td>0.6</td><td>56</td><td>101.1</td><td>0.13</td><td>223</td><td>5.4</td><td>1490</td><td>13.1</td><td>3.1</td><td>20.0</td><td>0</td></tr>
            <tr><td>2024-12-06</td><td>1.0</td><td>57</td><td>101.0</td><td>0.14</td><td>224</td><td>5.5</td><td>1500</td><td>13.4</td><td>3.2</td><td>20.6</td><td>2</td></tr>
            <tr><td>2024-12-07</td><td>1.5</td><td>58</td><td>100.9</td><td>0.15</td><td>225</td><td>5.6</td><td>1510</td><td>13.7</td><td>3.3</td><td>21.1</td><td>0</td></tr>
            <tr><td>2024-12-08</td><td>1.9</td><td>59</td><td>100.8</td><td>0.16</td><td>226</td><td>5.7</td><td>1520</td><td>14.0</td><td>3.4</td><td>21.7</td><td>0</td></tr>
            <tr><td>2024-12-09</td><td>2.3</td><td>60</td><td>100.7</td><td>0.17</td><td>227</td><td>5.8</td><td>1530</td><td>14.3</td><td>3.5</td><td>22.3</td><td>1</td></tr>
            <tr><td>2024-12-10</td><td>-0.5</td><td>53</td><td>101.2</td><td>0.12</td><td>221</td><td>5.1</td><td>1465</td><td>12.6</td><td>2.8</td><td>18.9</td><td>0</td></tr>
            <tr><td>2024-12-11</td><td>1.3</td><td>55</td><td>100.9</td><td>0.10</td><td>222</td><td>5.0</td><td>1475</td><td>12.8</td><td>2.9</td><td>19.2</td><td>0</td></tr>
            <tr><td>2024-12-12</td><td>-0.3</td><td>54</td><td>101.0</td><td>0.11</td><td>220</td><td>5.2</td><td>1485</td><td>13.0</td><td>3.0</td><td>19.6</td><td>1</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bottom config -->
  <div class="config">
    <h3 id="splitOrRoleTitle">è®­ç»ƒ / æµ‹è¯•é…ç½®</h3>

    <!-- å•æ–‡ä»¶ï¼šæ¯”ä¾‹åˆ‡åˆ† -->
    <div id="singleSplitBox" style="display:none;">
      <div class="hint">å•æ–‡ä»¶å°†æŒ‰æ¯”ä¾‹åˆ‡åˆ†è®­ç»ƒé›† / æµ‹è¯•é›†ï¼ˆæ”¯æŒ 0% / 100%ï¼‰ã€‚</div>
      <div style="display:flex; align-items:center; gap:12px;">
        <label style="font-size:12px; width:72px;">è®­ç»ƒæ¯”ä¾‹</label>
        <input id="trainPct" type="range" min="0" max="100" value="80" style="flex:1;" />
        <div style="display:flex; align-items:center; gap:8px; font-size:12px;">
          <span><b id="trainPctText">80</b>% è®­ç»ƒ</span>
          <span style="color:var(--muted);">/</span>
          <span><b id="testPctText">20</b>% æµ‹è¯•</span>
        </div>
      </div>
    </div>

    <!-- å¤šæ–‡ä»¶ï¼šæ–‡ä»¶è§’è‰²åˆ’åˆ† -->
    <div id="multiRoleBox" style="display:none;">
      <div class="hint">å¤šæ–‡ä»¶æ—¶è¯·æŒ‡å®šè®­ç»ƒæ–‡ä»¶ï¼ˆå¯å¤šä¸ªï¼‰ä¸æµ‹è¯•æ–‡ä»¶ï¼ˆä»… 1 ä¸ªï¼‰ã€‚</div>
      <div class="hint danger" id="multiRoleWarning" style="display:none;">è¯·æŒ‡å®šä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œå¦åˆ™æ— æ³•è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</div>
      <table class="file-role-table">
        <thead><tr><th>æ–‡ä»¶å</th><th>è§’è‰²</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="margin-top:12px;">ç‰¹å¾åˆ—é€‰æ‹©</h3>
    <div>
      <span class="tag selected">temperature</span>
      <span class="tag selected">humidity</span>
      <span class="tag">pressure</span>
      <span class="tag">vibration</span>
      <span class="tag">voltage</span>
      <span class="tag">current</span>
      <span class="tag">rpm</span>
      <span class="tag">torque</span>
    </div>

    <h3 style="margin-top:12px;">é¢„æµ‹ç›®æ ‡</h3>
    <div>
      <select style="font-size:12px; padding:4px;">
        <option selected>vibration</option>
        <option>temperature</option>
        <option>humidity</option>
        <option>pressure</option>
        <option>power</option>
      </select>
    </div>
  </div>
</div>

<footer>
  <button type="button">ä¸Šä¸€æ­¥</button>
  <button class="primary" id="nextBtn" type="button">ä¸‹ä¸€æ­¥</button>
</footer>

<script>
  // ====== çŠ¶æ€æ¨¡å‹ ======
  const state = {
    selectedFiles: new Set(["ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨1.csv","ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨2.csv","ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨3.csv"]),
    fileRoles: {
      "ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨1.csv": "æµ‹è¯•é›†",
      "ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨2.csv": "è®­ç»ƒé›†",
      "ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨3.csv": "è®­ç»ƒé›†"
    },
    previewFile: "ç”Ÿäº§çº¿ä¼ æ„Ÿå™¨1.csv",
    splitTrainPct: 80
  };

  // ====== äº‹ä»¶ç»‘å®š ======
  document.querySelectorAll('.tree .file-row .preview-icon').forEach(icon => {
    icon.addEventListener('click', () => setPreview(icon.dataset.file));
  });

  document.querySelectorAll('.tree .file-row input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', onFileSelectionChange);
  });

  document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
  document.addEventListener('fullscreenchange', syncFullscreenButton);

  // å±•å¼€ / æ”¶èµ·
  document.querySelectorAll('.tree .branch').forEach(b => {
    b.addEventListener('click', () => {
      const children = b.nextElementSibling;
      if (!children || !children.classList.contains('children')) return;
      const collapsed = children.getAttribute('data-collapsed') === 'true';
      children.setAttribute('data-collapsed', collapsed ? 'false' : 'true');
      const caret = b.querySelector('.caret');
      if (caret) caret.textContent = collapsed ? 'â–¾' : 'â–¸';
    });
  });

  // ä¸‹ä¸€æ­¥æŒ‰é’®æ¼”ç¤ºï¼šå¤šæ–‡ä»¶æ—¶å¿…é¡»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæµ‹è¯•é›†
  document.getElementById('nextBtn').addEventListener('click', () => {
    const files = Array.from(state.selectedFiles);
    if (files.length > 1) {
      const testCount = files.filter(f => state.fileRoles[f] === 'æµ‹è¯•é›†').length;
      if (testCount !== 1) {
        alert('è¯·å…ˆæŒ‡å®š 1 ä¸ªæµ‹è¯•æ–‡ä»¶ã€‚');
        return;
      }
    }
    alert('åŸå‹æ¼”ç¤ºï¼šé€šè¿‡æ ¡éªŒï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥ã€‚');
  });

  function onFileSelectionChange() {
    state.selectedFiles.clear();

    document.querySelectorAll('.tree .file-row').forEach(row => {
      const cb = row.querySelector('input[type="checkbox"]');
      const file = row.getAttribute('data-file');
      if (cb && cb.checked) state.selectedFiles.add(file);
    });

    // æ¸…ç† fileRoles ä¸­å·²å–æ¶ˆé€‰æ‹©çš„æ–‡ä»¶
    Object.keys(state.fileRoles).forEach(f => {
      if (!state.selectedFiles.has(f)) delete state.fileRoles[f];
    });

    // å¦‚æœé¢„è§ˆæ–‡ä»¶è¢«å–æ¶ˆå‹¾é€‰ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªé€‰ä¸­
    if (state.previewFile && !state.selectedFiles.has(state.previewFile)) {
      const next = Array.from(state.selectedFiles)[0] || '';
      if (next) setPreview(next);
    }

    // å¤šæ–‡ä»¶åœºæ™¯ï¼šä¿è¯æœ€å¤šåªæœ‰ä¸€ä¸ªæµ‹è¯•é›†
    enforceSingleTestRole();

    renderTrainTestConfig();
  }

  function setPreview(file) {
    state.previewFile = file;

    // é€‰ä¸­æ€ï¼šå·¦ä¾§æ–‡ä»¶å + é¢„è§ˆ icon
    document.querySelectorAll('.tree .file-row').forEach(row => {
      const f = row.getAttribute('data-file');
      const nameEl = row.querySelector('.file-name');
      const iconEl = row.querySelector('.preview-icon');
      if (nameEl) nameEl.classList.toggle('active', f === file);
      if (iconEl) iconEl.classList.toggle('active', f === file);
    });

    // æ ‡é¢˜æ˜¾ç¤º
    updatePreviewHeader();

    // åŸå‹ï¼šä¸åšçœŸå®æ•°æ®åˆ‡æ¢ï¼Œåªåšâ€œå½“å‰é¢„è§ˆâ€çŠ¶æ€æ¼”ç¤º
  }

  function updatePreviewHeader() {
    const files = Array.from(state.selectedFiles);
    const title = document.getElementById('previewTitle');
    const current = state.previewFile ? `ï¼ˆå½“å‰é¢„è§ˆï¼š${state.previewFile}ï¼‰` : '';
    title.textContent = `æ•°æ®é¢„è§ˆï¼ˆå·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶ï¼‰${current}`;
  }

  function toggleFullscreen() {
    const panel = document.getElementById('previewPanel');
    if (!document.fullscreenElement) {
      if (panel.requestFullscreen) panel.requestFullscreen();
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
    }
  }

  function syncFullscreenButton() {
    const btn = document.getElementById('fullscreenBtn');
    btn.textContent = document.fullscreenElement ? 'é€€å‡ºå…¨å±' : 'å…¨å±';
  }

  function enforceSingleTestRole() {
    const files = Array.from(state.selectedFiles);

    if (files.length <= 1) {
      // å•æ–‡ä»¶ä¸éœ€è¦ fileRoles
      return;
    }

    // å¦‚æœæ²¡æœ‰æµ‹è¯•é›†ï¼Œé»˜è®¤ç»™ç¬¬ä¸€ä¸ªæ–‡ä»¶æµ‹è¯•é›†ï¼ˆä»…ç”¨äºåŸå‹æ¼”ç¤ºï¼Œé¿å…â€œç©ºçŠ¶æ€â€ï¼‰
    let testFile = files.find(f => state.fileRoles[f] === 'æµ‹è¯•é›†');
    if (!testFile) {
      testFile = files[0];
      state.fileRoles[testFile] = 'æµ‹è¯•é›†';
    }

    // å…¶ä»–æ–‡ä»¶å…¨éƒ¨è®­ç»ƒé›†
    files.forEach(f => {
      if (f !== testFile) state.fileRoles[f] = 'è®­ç»ƒé›†';
    });
  }

  function renderTrainTestConfig() {
    const files = Array.from(state.selectedFiles);

    updatePreviewHeader();

    const singleBox = document.getElementById('singleSplitBox');
    const multiBox  = document.getElementById('multiRoleBox');
    const titleEl   = document.getElementById('splitOrRoleTitle');
    const warnEl    = document.getElementById('multiRoleWarning');

    if (files.length === 1) {
      // å•æ–‡ä»¶
      titleEl.textContent = 'è®­ç»ƒ / æµ‹è¯•æ¯”ä¾‹ï¼ˆå•æ–‡ä»¶åˆ‡åˆ†ï¼‰';
      singleBox.style.display = '';
      multiBox.style.display = 'none';

      const slider = document.getElementById('trainPct');
      const trainText = document.getElementById('trainPctText');
      const testText  = document.getElementById('testPctText');

      slider.value = String(state.splitTrainPct);
      trainText.textContent = String(state.splitTrainPct);
      testText.textContent  = String(100 - state.splitTrainPct);

      slider.oninput = () => {
        state.splitTrainPct = Number(slider.value);
        trainText.textContent = String(state.splitTrainPct);
        testText.textContent  = String(100 - state.splitTrainPct);
      };

      return;
    }

    // å¤šæ–‡ä»¶
    titleEl.textContent = 'è®­ç»ƒ / æµ‹è¯•æ–‡ä»¶åˆ’åˆ†ï¼ˆå¤šæ–‡ä»¶ï¼‰';
    singleBox.style.display = 'none';
    multiBox.style.display = '';

    enforceSingleTestRole();

    const tbody = document.querySelector('#multiRoleBox .file-role-table tbody');
    tbody.innerHTML = '';

    files.forEach(file => {
      if (!state.fileRoles[file]) state.fileRoles[file] = 'è®­ç»ƒé›†';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(file)}</td>
        <td>
          <select data-file="${escapeAttr(file)}">
            <option value="è®­ç»ƒé›†" ${state.fileRoles[file] === 'è®­ç»ƒé›†' ? 'selected' : ''}>è®­ç»ƒé›†</option>
            <option value="æµ‹è¯•é›†" ${state.fileRoles[file] === 'æµ‹è¯•é›†' ? 'selected' : ''}>æµ‹è¯•é›†</option>
          </select>
        </td>`;
      tbody.appendChild(tr);
    });

    // ç»‘å®š select çš„ changeï¼ˆé¿å… inline onchange å¯¼è‡´çš„å­—ç¬¦ä¸²æ³¨å…¥/è½¬ä¹‰é—®é¢˜ï¼‰
    tbody.querySelectorAll('select').forEach(sel => {
      sel.addEventListener('change', () => {
        const file = sel.getAttribute('data-file');
        const role = sel.value;
        onRoleChange(file, role);
      });
    });

    // æ ¡éªŒæç¤º
    const testCount = files.filter(f => state.fileRoles[f] === 'æµ‹è¯•é›†').length;
    warnEl.style.display = testCount === 1 ? 'none' : '';
  }

  function onRoleChange(file, role) {
    // å…è®¸å¤šä¸ªè®­ç»ƒé›†ï¼›æµ‹è¯•é›†åªèƒ½ 1 ä¸ª
    if (role === 'æµ‹è¯•é›†') {
      Object.keys(state.fileRoles).forEach(f => {
        if (f !== file) state.fileRoles[f] = 'è®­ç»ƒé›†';
      });
    }
    state.fileRoles[file] = role;

    renderTrainTestConfig();
  }

  // ====== å°å·¥å…·ï¼šè½¬ä¹‰ï¼ˆé˜²æ­¢åŸå‹é‡Œå†™æ­»çš„æ–‡ä»¶åå«å¼•å·æ—¶ç‚¸ DOMï¼‰ ======
  function escapeHtml(s) {
    return String(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }
  function escapeAttr(s) { return escapeHtml(s); }

  // ====== ç®€å•è‡ªæµ‹ï¼ˆæ–¹ä¾¿ä½ å¿«é€ŸéªŒè¯å¤šæ–‡ä»¶/å•æ–‡ä»¶é€»è¾‘æ²¡æœ‰æ–­ï¼‰ ======
  function runTests() {
    try {
      // 1) è§’è‰²è¡¨è¡Œæ•° = é€‰ä¸­æ–‡ä»¶æ•°ï¼ˆå¤šæ–‡ä»¶æ—¶ï¼‰
      const files = Array.from(state.selectedFiles);
      renderTrainTestConfig();
      if (files.length > 1) {
        const rows = document.querySelectorAll('#multiRoleBox tbody tr').length;
        console.assert(rows === files.length, `role table rows(${rows}) should equal selected files(${files.length})`);

        const testCount = files.filter(f => state.fileRoles[f] === 'æµ‹è¯•é›†').length;
        console.assert(testCount === 1, `test file count should be 1, got ${testCount}`);
      }

      // 2) é¢„è§ˆ title ä¸åº”ä¸¢å¤±å…¨å±æŒ‰é’®ï¼ˆæˆ‘ä»¬ç”¨ç‹¬ç«‹ title span å·²è§„é¿ï¼‰
      const btn = document.getElementById('fullscreenBtn');
      console.assert(!!btn, 'fullscreenBtn should exist');

    } catch (e) {
      console.error('Self tests failed:', e);
    }
  }

  // åˆå§‹æ¸²æŸ“
  setPreview(state.previewFile);
  renderTrainTestConfig();
  runTests();
</script>
</body>
</html>
