# 因果洞察 (Causal Insight) 产品需求文档 (PRD)

## 1. 项目背景与目标

**因果洞察** 旨在为用户提供超越传统相关性分析的深度归因能力。通过基于现有的决策推理任务（Decision Tasks），进一步通过**切片分析**（Slicing）和**反事实推断**（Counterfactual Reasoning），量化不同特征因子（X）对目标变量（Y）的净影响（Causal Impact）。

**核心目标：**

1. **量化影响**：不仅知道谁与 Y 相关，更要知道谁 *导致* 了 Y 的变化以及影响程度。
2. **归因分析**：在特定样本子集（如“高流失风险客户”）下，分析其核心致因。
3. **闭环验证**：通过构建不同的样本过滤器（Filters），快速验证假设。

## 2. 核心流程与角色

* **目标用户**：数据分析师、业务决策者。
* **核心流程**：
    1. **选择任务**：基于已有的决策任务（Decision Task）作为数据源。
    2. **定义目标**：选择分析目标（Y）及其关注的取值范围（如“销售额 < 1000”或“流失概率 > 0.8”）。
    3. **配置过滤**：设置样本过滤条件（Filters），聚焦特定业务场景。
    4. **自动推断**：系统自动识别潜在的影响因子（X）。
    5. **查看结果**：通过热力图（时序变化）和条形图（影响权重）查看分析结论。
    6. **导出报告**：生成离线报告用于汇报。

## 3. 功能需求详细说明

### 3.1 任务列表 (Task List)

**功能描述**：展示所有因果洞察任务的管理视图。

* **列表展示**：
  * **字段**：任务名称、ID、来源任务名称、Y 字段、样本命中情况（进度条 + 数值）、状态（Badge）、创建人、操作。
  * **状态枚举**：`DRAFT` (草稿), `QUEUED` (排队中), `RUNNING` (运行中), `SUCCEEDED` (成功), `FAILED` (失败)。
* **筛选与搜索**：
  * 支持按“任务名称”或“任务ID”进行模糊搜索。
  * 支持高级筛选（UI 预留）。
* **操作交互**：
  * **新建任务**：点击跳转至创建向导。
  * **查看详情**：点击名称或“眼睛”图标进入详情页。
  * **复制任务**：一键复制现有任务配置，生成副本（名称自动添加后缀）。
  * **删除任务**：二次确认后删除任务记录。
  * **空态处理**：无数据时展示 Empty 状态。

### 3.2 创建任务 (Create Task)

**功能描述**：引导用户配置因果分析的核心参数。采用**单页双栏布局**。

#### 3.2.1 基础配置 (左栏)

1. **决策推理任务选择**：
    * 下拉选择已完成的 Decision Task。
    * 联动：选择后自动加载该任务的 Schema（字段元数据）。
2. **分析目标 (Y) 配置**：
    * **字段选择**：从 Schema 中选择一个字段作为 Y。
    * **范围/值定义**（根据 Y 字段类型动态展示）：
        * **数值型 (Numeric)**：双向滑块 (Slider) + 输入框 (InputNumber)，设定 Min/Max 区间。
        * **时间型 (Temporal)**：日期范围选择器 (RangePicker)。
        * **分类/枚举型 (Categorical)**：多选框组 (Checkbox Group) 或 多选下拉 (Select Multiple)。
    * **数据预览**：展示选中 Y 字段的统计信息（如 Min/Max, Avg, 可选值列表）。

#### 3.2.2 样本条件过滤 (右栏)

1. **影响因子 (X) 自动识别**：
    * **逻辑**：系统自动选取源任务中除 Y 字段和 Time 字段以外的所有字段作为潜在 X 因子。
    * **UI**：不再需要用户手动勾选 X 字段（简化流程）。
2. **过滤条件管理**：
    * **列表展示**：表格形式展示已添加的过滤器（字段 | 操作符 | 值）。
    * **添加/编辑过滤器** (Modal 弹窗)：
        * 选择字段。
        * 选择操作符 (`=`, `>`, `<`, `BETWEEN`, `IN`)。
        * 输入/选择值（根据字段类型适配 UI控件，如 DatePicker, InputNumber, Select）。
    * **删除**：移除单条过滤条件。
3. **样本覆盖估算**：
    * **实时反馈**：当配置（Y 范围或 Filters）发生变化时，自动触发估算请求（防抖）。
    * **展示指标**：命中样本数 / 总样本数，匹配比例 (%)。
    * **加载状态**：估算过程中显示 Loading 动画。

#### 3.2.3 底部操作栏

* **保存草稿**：保存当前配置，状态置为 `DRAFT`。
* **保存并运行**：提交任务，状态置为 `QUEUED` -> `RUNNING`。需校验必填项（SourceTask, Y, X not empty）。

### 3.3 任务详情 (Task Detail)

**功能描述**：展示分析结果与可视化的核心页面。

#### 3.3.1 头部信息与操作

* **面包屑/返回**：快速返回列表。
* **任务元数据**：标题、ID、状态 Badge、来源任务、创建时间。
* **操作按钮**：
  * **导出报告**：生成包含图表快照 (PDF) 和源数据 (CSV) 的 ZIP 包。
    * *交互*：点击 -> Loading -> 浏览器下载。

#### 3.3.2 配置回显 (Read-only Overview)

* 以卡片形式精简展示：来源任务、X 因子列表、Y 目标设定、已生效的过滤条件。
* 样式统一：使用 Tag 和 Descriptions 风格保持整洁。

#### 3.3.3 洞察结果展示 (Insight Results)

分为两个主要维度，每个维度支持 **可视化 (Visual)** 和 **原数据 (Raw Data)** 两种视图切换。

1. **当前筛选条件下的分析结果 (Filtered Analysis)**：
    * **数据源**：基于配置的 Filters 筛选后的样本子集。
    * **可视化视图**：
        * **因果热力图**：X 轴为时间，Y 轴为因子，颜色深浅表示影响强度。
        * **影响分数对比图 (Bar Chart)**：按影响分数绝对值排序，区分正向/负向影响（双向条形图）。
    * **原数据视图**：
        * **样本数据列表**：分页表格，展示该筛选条件下实际的样本明细数据（用于核对）。
2. **全量样本分析结果 (Full Sample Analysis)**：
    * **数据源**：未应用过滤条件的全量数据集（作为 Baseline 对比）。
    * **可视化视图**：同上（热力图 + 条形图）。
    * **原数据视图**：全量样本数据分页表格。

#### 3.3.4 全屏预览

* 支持在弹窗中全屏查看样本数据表格，提供更大的阅读空间。

## 4. 数据结构模型 (Data Model)

### 4.1 任务对象 (CausalInsightTask)

```typescript
interface CausalInsightTask {
  id: string;               // 任务ID (CI-xxx)
  name: string;             // 任务名称
  projectId: string;        // 所属项目
  sourceDecisionTaskId: string; // 来源决策任务ID
  sourceDecisionTaskName: string;
  datasetSnapshotId: string; // 数据快照ID
  
  // X 因子配置
  xSpec: {
    mode: 'explicit' | 'rule'; // 目前默认 explicit + 自动全选
    fields: string[];          // 参与分析的特征列表
  };
  
  // Y 目标配置
  ySpec: {
    field: string;
    filterType: 'Numeric' | 'Temporal' | 'Categorical';
    // 范围配置通常存储在 filters 或单独字段，此处简化
  };
  
  // 过滤条件
  filters: {
    and: Array<{
      id?: number;
      field: string;
      op: 'BETWEEN' | '=' | '>' | '<' | 'IN';
      value: any;
    }>;
  };
  
  // 运行状态
  status: 'DRAFT' | 'QUEUED' | 'RUNNING' | 'SUCCEEDED' | 'FAILED';
  progress: number;         // 0-100
  sampleTotal: number;      // 总样本
  sampleHit: number;        // 命中样本
  
  // 审计字段
  createdAt: string;
  createdBy: string;
  updatedAt: string;
}
```

## 5. 交互与体验规范 (UI/UX)

1. **一致性**：遵循 Ant Design 设计规范。
2. **反馈**：
    * 异步操作（提交、删除、导出）必须有 Loading 状态。
    * 成功/失败操作需调用 `message.success` / `message.error` 全局提示。
3. **空态设计**：列表为空、图表无数据时，需展示友好的 Empty 占位符。
4. **响应式**：适配主流桌面分辨率，详情页图表区域应自适应宽度。
5. **颜色规范**：
    * 正向影响：红色偏暖色系（如 `#ef4444`）。
    * 负向影响：蓝色/绿色偏冷色系（如 `#3b82f6`）。
    * 主色调：`slate-900` (文本), `blue-600` (交互)。

## 6. 导出报告规范

* **格式**：ZIP 压缩包。
* **命名**：`{TaskName}_{YYYYMMDD_HHmm}.zip`。
* **内容**：
  * `analysis_report.pdf`: 包含热力图和条形图的截图，按章节排版。
  * `filtered_data.csv`: 筛选后的源数据 CSV。
  * `full_data.csv`: 全量源数据 CSV。
